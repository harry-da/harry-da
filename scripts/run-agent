#!/bin/bash
set -e

# Script to run opencode agents
# Usage: ./run-agent <agent-id>

if [ -z "$1" ]; then
  echo "Error: Agent ID is required"
  echo "Usage: $0 <agent-id>"
  exit 1
fi

JOB_ID="$1"
AGENT_DIR="agents/${JOB_ID}"
LOGS_DIR="${AGENT_DIR}/logs"
AGENT_FILE="${AGENT_DIR}/agent.md"
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
OUTPUT_FILE="${LOGS_DIR}/${TIMESTAMP}.yml"
WORKDIR=$(mktemp -d)

# Store absolute path to output file for use from work directory
REPO_DIR="$(pwd)"
OUTPUT_FILE_ABS="${REPO_DIR}/${OUTPUT_FILE}"

# Check if agent file exists
if [ ! -f "$AGENT_FILE" ]; then
  echo "Error: Agent file not found at $AGENT_FILE"
  exit 1
fi

# Create agent and logs directories if they don't exist
mkdir -p "$AGENT_DIR" "$LOGS_DIR"

echo "============================================"
echo "Running agent: ${JOB_ID}"
echo "Agent file: ${AGENT_FILE}"
echo "Output file: $OUTPUT_FILE"
echo "Work directory: $WORKDIR"
echo "============================================"
echo ""

# Copy agent file to opencode agent directory
mkdir -p ~/.config/opencode/agent
cp "$AGENT_FILE" ~/.config/opencode/agent/"${JOB_ID}.md"

echo "Copied agent to ~/.config/opencode/agent/${JOB_ID}.md"
echo ""

# STEP 1: Copy existing agent assets to work directory
echo "Copying existing agent assets to work directory..."
# Copy all files from agent directory except agent.md (we'll handle it separately)
find "$AGENT_DIR" -mindepth 1 -maxdepth 1 -not -name "agent.md" -not -name "logs" | while read file; do
    cp -r "$file" "$WORKDIR/" 2>/dev/null || true
done
# Copy agent.md
cp "$AGENT_FILE" "$WORKDIR/"
echo "Assets copied to: $WORKDIR"
echo ""

# Change to work directory and run opencode
cd "$WORKDIR"
echo "Running: opencode run @${JOB_ID} --model github-copilot/claude-sonnet-4 --format json"
echo ""

# Run opencode and convert JSON lines to YAML
TEMP_JSON=$(mktemp)
TEMP_STDERR=$(mktemp)
RAW_OUTPUT="${LOGS_DIR}/${TIMESTAMP}.raw.log"

# Capture both stdout and stderr separately
if opencode run "@${JOB_ID}" --model github-copilot/claude-sonnet-4 --format json > "${TEMP_JSON}" 2> "${TEMP_STDERR}"; then
  EXIT_CODE=0
else
  EXIT_CODE=$?
fi

# Always save the raw output for debugging
echo "Saving raw output to: ${RAW_OUTPUT}"
{
  echo "=== OpenCode Execution Log ==="
  echo "Timestamp: ${TIMESTAMP}"
  echo "Agent: ${JOB_ID}"
  echo "Exit Code: ${EXIT_CODE}"
  echo ""
  echo "=== STDERR ==="
  cat "${TEMP_STDERR}"
  echo ""
  echo "=== STDOUT (Raw JSON) ==="
  cat "${TEMP_JSON}"
  echo ""
  echo "=== Line Count ==="
  echo "Total lines: $(wc -l < "${TEMP_JSON}")"
  echo "Non-empty lines: $(grep -c . "${TEMP_JSON}" || echo "0")"
} > "${OUTPUT_FILE_ABS}.raw"

if [ ${EXIT_CODE} -eq 0 ]; then
  echo "OpenCode execution completed successfully"
  
  # Check if we have any output
  LINE_COUNT=$(wc -l < "${TEMP_JSON}")
  NON_EMPTY_LINES=$(grep -c . "${TEMP_JSON}" || echo "0")
  echo "Output: ${NON_EMPTY_LINES} non-empty lines out of ${LINE_COUNT} total"
  
  # Convert line-delimited JSON to YAML if yq is available, otherwise keep as JSON
  if command -v yq >/dev/null 2>&1; then
    echo "Converting JSON lines to YAML..."
    # Process each line as a separate JSON object and convert to YAML
    {
      echo "# OpenCode Agent Execution Log"
      echo "# Timestamp: ${TIMESTAMP}"
      echo "# Agent: ${JOB_ID}"
      echo "# Exit Code: ${EXIT_CODE}"
      echo "# Lines processed: ${NON_EMPTY_LINES}"
      echo ""
      first=true
      line_num=0
      while IFS= read -r line; do
        if [ -n "$line" ]; then
          line_num=$((line_num + 1))
          # Filter out all sessionID fields recursively and other unnecessary IDs
          filtered_json=$(echo "$line" | yq eval '
            del(.sessionID) | 
            del(.part.sessionID) | 
            del(.part.id) |
            del(.text.sessionID) |
            del(.metadata.summary[]?.sessionID) |
            del(.metadata.summary[]?.id)
          ' 2>/dev/null || echo "$line")
          
          if [ "$first" = true ]; then
            echo "- $(echo "$filtered_json" | yq eval -P '.' 2>/dev/null | sed '1s/^//' | sed '2,\$s/^/  /' || echo "$filtered_json")"
            first=false
          else
            echo "- $(echo "$filtered_json" | yq eval -P '.' 2>/dev/null | sed '1s/^//' | sed '2,\$s/^/  /' || echo "$filtered_json")"
          fi
        fi
      done < "${TEMP_JSON}"
      
      if [ "$line_num" -eq 0 ]; then
        echo "# WARNING: No output lines were processed"
        echo "# Check ${TIMESTAMP}.raw.log for raw output"
      fi
    } > "${OUTPUT_FILE_ABS}"
  else
    echo "yq not found, keeping JSON format..."
    cp "${TEMP_JSON}" "${OUTPUT_FILE_ABS}"
  fi
else
  echo "OpenCode execution failed with exit code: ${EXIT_CODE}"
  {
    echo "# OpenCode Agent Execution FAILED"
    echo "# Timestamp: ${TIMESTAMP}"
    echo "# Agent: ${JOB_ID}"
    echo "# Exit Code: ${EXIT_CODE}"
    echo ""
    echo "# Error Output:"
    cat "${TEMP_STDERR}"
    echo ""
    echo "# Standard Output:"
    cat "${TEMP_JSON}"
  } > "${OUTPUT_FILE_ABS}"
  cat "${OUTPUT_FILE_ABS}"
fi

rm -f "${TEMP_JSON}" "${TEMP_STDERR}"

# STEP 2: Copy any new files created by the agent back to the agent directory
echo ""
echo "Copying new files back to agent directory..."
# Find all files and directories created by the agent (excluding agent.md and temp files)
find "$WORKDIR" -mindepth 1 -maxdepth 1 | while read file; do
    basename_file=$(basename "$file")
    # Skip agent.md (it's already in the right place) and skip any temp/system files
    if [[ "$basename_file" != "agent.md" && "$basename_file" != "logs" && ! "$basename_file" =~ ^tmp ]]; then
        echo "Copying: $basename_file"
        if [ -d "$file" ]; then
            # Handle directories - merge if exists, otherwise copy
            if [ -d "$REPO_DIR/$AGENT_DIR/$basename_file" ]; then
                cp -r "$file"/* "$REPO_DIR/$AGENT_DIR/$basename_file/" 2>/dev/null || true
            else
                cp -r "$file" "$REPO_DIR/$AGENT_DIR/"
            fi
        else
            # Handle files - overwrite if exists
            cp "$file" "$REPO_DIR/$AGENT_DIR/"
        fi
    fi
done

# Clean up work directory
cd -
rm -rf "$WORKDIR"

echo ""
echo "Agent completed!"
echo "Results saved to: $OUTPUT_FILE"

# Keep only the last 10 logs to avoid repository bloat
cd "$LOGS_DIR"
ls -t *.yml 2>/dev/null | tail -n +11 | xargs -r rm --
# Also clean up old raw logs, keeping last 10
ls -t *.raw.log 2>/dev/null | tail -n +11 | xargs -r rm --
echo "Cleaned up old logs (keeping last 10 of each type)"
