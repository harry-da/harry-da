#!/bin/bash

# Script to update the HOME_TAR GitHub secret with home directory files

if [ $# -eq 0 ]; then
    echo "Usage: $0 <path1> [path2] [path3] ..."
    echo "Example: $0 ~/.local/share/opencode/auth.json ~/.config/opencode/settings.json"
    exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Please run this script from the git repository root."
    exit 1
fi

# Check if all paths exist
for path in "$@"; do
    if [ ! -e "$path" ]; then
        echo "Error: Path does not exist: $path"
        exit 1
    fi
done

echo "Creating tar ..."
for path in "$@"; do
    echo "  $path"
done

# Create tar archive with relative paths from home directory
# This preserves the directory structure when extracted
cd ~
tar_content=$(tar -czf - --exclude-from=/dev/null $(printf '%s\n' "$@" | sed "s|^$HOME/||" | sed "s|^~/||") | base64)

if [ $? -ne 0 ]; then
    echo "Error: Failed to create tar archive"
    exit 1
fi

cd -
echo "Updating GitHub secret HOME_TAR..."
gh secret set HOME_TAR --body "$tar_content"

if [ $? -eq 0 ]; then
    echo "✅ Successfully updated HOME_TAR secret"
else
    echo "❌ Failed to update GitHub secret"
    exit 1
fi